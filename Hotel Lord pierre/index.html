<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Control de Habitaciones - Hotel Lord Pierre</title>
<style>
  :root{
    --gris-panel:#f3f4f6;
    --azul:#2563eb;
    --rojo:#ef4444;
    --verde:#22c55e;
    --naranja:#f97316;
    --amarillo:#eab308;
    --estrella:#dc2626;
    --borde:#d1d5db;
  }

  *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif;}
  body{background:#f9fafb;display:flex;height:100vh;overflow:hidden;}

  /* Logo fijo discreto */
  .logo-fijo {
    position: fixed;
    bottom: 10px;
    right: 10px;
    z-index: 50;
    opacity: 0.6;
    transition: opacity 0.3s ease;
  }
  .logo-fijo:hover { opacity: 1; }
  .logo-fijo img {
    height: 50px;
    width: auto;
    object-fit: contain;
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
    pointer-events: none;
    user-select: none;
  }

  /* Sidebar pisos */
  .sidebar{
    background:var(--gris-panel);
    width:220px; display:flex; flex-direction:column; align-items:center;
    gap:14px; padding:20px 12px; border-right:1px solid var(--borde);
    overflow-y:auto;
  }
  .btn-piso{
    width:100%; padding:12px; border:none; border-radius:10px;
    font-size:15px; font-weight:700; color:#fff; background:var(--azul);
    cursor:pointer; transition:.2s;
  }
  .btn-piso:hover{filter:brightness(.95);}
  .btn-piso.active{background:#fff;color:var(--azul);border:2px solid var(--azul);}

  /* Main */
  .main{
    flex:1; display:flex; flex-direction:column; align-items:center;
    padding:18px; overflow-y:auto; position:relative;
  }
  .piso{
    opacity:0; transform:translateX(100%); position:absolute; transition:.45s ease;
    width:100%; display:flex; flex-direction:column; align-items:center;
  }
  .piso.active{opacity:1; transform:translateX(0); position:relative;}
  .titulo-piso{font-size:22px;margin:6px 0 16px;font-weight:800;}

  /* Layout */
  .contenedor{display:flex;flex-direction:column;align-items:center;gap:20px;}
  @media(min-width:900px){.contenedor{flex-direction:row;align-items:flex-start;gap:56px;}}

  /* Mapa */
  .mapa{
    background:#4b5563; padding:22px; border-radius:14px;
    display:flex; justify-content:center; gap:28px; flex-wrap:wrap;
  }
  .columna{display:flex;flex-direction:column;gap:10px;}
  .pasillo{display:flex;justify-content:space-between;width:100%;gap:80px;}

  /* Habitaci√≥n */
  .habitacion{
    width:70px;height:54px;border-radius:14px;color:#000;font-weight:800;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    cursor:pointer;position:relative;transition:transform .08s;
  }
  .habitacion:hover{transform:scale(1.04);}
  .habitacion.selected{outline:4px solid #000;outline-offset:-4px;}
  .verde{background:var(--verde);} .naranja{background:var(--naranja);}
  .amarillo{background:var(--amarillo);} .rojo{background:var(--rojo);}
  .estado-label{position:absolute;bottom:4px;font-size:11px;font-weight:700;color:#000;text-shadow:0 1px 2px #fff8;}
  .estrella-nota{position:absolute;top:6px;right:8px;color:var(--estrella);font-size:18px;line-height:1;}

  /* Paneles */
  .panel{display:flex;flex-direction:column;align-items:center;gap:16px;width:92%;max-width:360px;}
  .box{background:#fff;border:1px solid var(--borde);border-radius:12px;padding:16px;width:100%;box-shadow:0 1px 4px rgba(0,0,0,.06);}
  .box h3{margin-bottom:10px;font-size:16px;}
  .leyenda-item{display:flex;align-items:center;margin:6px 0;font-size:14px;}
  .leyenda-color{width:18px;height:18px;border-radius:4px;margin-right:10px;border:1px solid #9994;}
  .actions{display:flex;gap:10px;margin-top:10px;align-items:center;}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid var(--borde);background:#f9fafb;cursor:pointer;font-weight:700;transition:.2s;}
  .btn:hover{background:#f3f4f6;}
  .btn.primary{background:#e0ecff;border-color:#bfdbfe;}
  .btn.danger{background:#fee2e2;border-color:#fecaca;}
  .badge{margin-left:auto;font-size:12px;color:#666;}
  .estado{display:flex;align-items:center;gap:10px;font-size:14px;}
  .estado .swatch{width:16px;height:16px;border-radius:4px;border:1px solid #9994;display:inline-block;}
  .reloj{font-size:13px;color:#555;text-align:right;margin-bottom:6px;}
  .resumen p{margin:6px 0;font-size:14px;line-height:1.4;}
  textarea{width:100%;height:110px;border:1px solid #ccc;border-radius:10px;resize:none;padding:10px;font-size:14px;background:#f9fafb;}

  /* Tabla ERP */
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px;}
  th, td{border-bottom:1px solid #e5e7eb;padding:8px;text-align:left;}
  th{background:#f3f4f6;font-weight:700;}
  tr:hover td{background:#f9fafb;}
  select, input[type="number"], input[type="text"]{width:100%;padding:6px;border:1px solid #d1d5db;border-radius:8px;background:#fff;}
  .delete-btn{background:none;border:none;color:#ef4444;font-size:16px;cursor:pointer;}

  /* Men√∫ de colores */
  .menu-colores{
    display:none; position:fixed; background:#fff; border:1px solid #ccc; border-radius:8px;
    padding:6px; box-shadow:0 0 12px rgba(0,0,0,.2); z-index:1000;
  }
  .color-opcion{width:30px;height:30px;border-radius:6px;margin:6px;display:inline-block;cursor:pointer;border:1px solid #9994;}

  /* Estado bloqueado por falta de operador */
  .blocked { opacity:.6; pointer-events:none; }
  .hint { font-size:12px; color:#6b7280; margin-top:6px; }

  /* === VISTA RESUMEN (3 pisos) === */
.resumen-multi{ display:none; width:100%; }
.resumen-multi.active{
  display:grid;
  /* ancho m√≠nimo suficiente para que quepan las dos columnas con el pasillo */
  grid-template-columns:repeat(auto-fit,minmax(520px,1fr));
  gap:22px; align-items:start;
}

.resumen-card{
  background:#fff;border:1px solid var(--borde);
  border-radius:14px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06);
  width:100%;
}
.resumen-card h3{font-size:18px;margin-bottom:10px;}
.resumen-card .kpis{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;}
.chip{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 8px; border-radius:999px; border:1px solid var(--borde);
  font-size:12px; background:#f9fafb;
}
.chip .dot{ width:12px;height:12px;border-radius:3px;border:1px solid #9994;}

/* <<< IMPORTANTE: mismas dimensiones que el mapa ‚Äúgrande‚Äù >>> */
.mini .habitacion{
  width:70px;height:54px;border-radius:14px;font-size:14px;
}
.mini .estado-label{font-size:11px;}
.mini-mapa{
  background:#4b5563;padding:22px;border-radius:14px;
  display:flex;justify-content:center;gap:28px;flex-wrap:wrap;margin-bottom:10px;
}
.mini .pasillo{ gap:80px; }


  @media(max-width:899px){
    body{flex-direction:column;}
    .sidebar{flex-direction:row;width:100%;gap:10px;overflow-x:auto;}
    .btn-piso{width:auto;}
    .main{padding:12px;}
  
  /* ====== FIX: Resumen 3 columnas, tama√±o normal y pasillo compacto ====== */
.resumen-multi.active{
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* fuerza 3 tarjetas por fila en desktop */
  gap: 20px;
  align-items: start;
}

/* Limita el ancho del card y del mini-mapa para que no se estiren */
.resumen-card{ width:100%; max-width: 500px; margin: 0 auto; }
.mini-mapa{
  max-width: 420px;           /* prueba 400‚Äì460 seg√∫n tu gusto */
  margin: 0 auto 10px;
  padding: 16px;
  border-radius: 14px;
  background: #4b5563;
  display: flex; justify-content: center; gap: 24px; flex-wrap: wrap;
}

/* Habitaciones tama√±o normal */
.mini .habitacion{ width:70px; height:54px; border-radius:14px; font-size:14px; }
.mini .estado-label{ font-size:11px; }

/* Pasillo m√°s angosto (compacto) */
.mini .pasillo{ gap:48px; }   /* si quieres a√∫n m√°s compacto: 40px */

/* KPIs en una l√≠nea (scroll si no caben) */
.resumen-card .kpis{
  display: flex; gap: 8px; overflow-x: auto; white-space: nowrap; padding-bottom: 4px;
}

/* Responsivo: cae a 2 y 1 columna seg√∫n ancho */
@media (max-width: 1500px){
  .resumen-multi.active{ grid-template-columns: repeat(2, 1fr); }
  .mini-mapa{ max-width: 400px; }
}
@media (max-width: 900px){
  .resumen-multi.active{ grid-template-columns: 1fr; }
  .mini-mapa{ max-width: 420px; }
}

</style>
</head>

<body>

<!-- Logo discreto del Hotel -->
<div class="logo-fijo">
  <img src="logo-lordpierre.png" alt="Hotel Lord Pierre" />
</div>

<!-- Sidebar pisos -->
<div class="sidebar">
  <button class="btn-piso active" data-piso="2">üè® Piso 2</button>
  <button class="btn-piso" data-piso="3">üè® Piso 3</button>
  <button class="btn-piso" data-piso="4">üè® Piso 4</button>
  <button class="btn-piso" data-piso="resumen">üìä Resumen (2‚Äì4)</button>
</div>

<div class="main">
  <div id="piso2" class="piso active"></div>
  <div id="piso3" class="piso"></div>
  <div id="piso4" class="piso"></div>

  <!-- Contenedor de la vista Resumen -->
  <div id="resumenView" class="resumen-multi"></div>
</div>

<!-- Men√∫ colores -->
<div class="menu-colores" id="menu">
  <div class="color-opcion" data-color="verde"   style="background:var(--verde)"   title="Vac√≠o limpio (VL)"></div>
  <div class="color-opcion" data-color="naranja" style="background:var(--naranja)" title="Vac√≠o sucio (VS)"></div>
  <div class="color-opcion" data-color="amarillo"style="background:var(--amarillo)"title="Ocupado (OC)"></div>
  <div class="color-opcion" data-color="rojo"    style="background:var(--rojo)"    title="Bloqueado (BL)"></div>
</div>

<!-- === Firebase + Realtime (CDN / ES Modules) === -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import {
    getFirestore, collection, doc, onSnapshot, setDoc,
    serverTimestamp, addDoc
  } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDg7vGSj6ipsY_kp-vfmWyv1QwXI74ZGIQ",
    authDomain: "hotellordpierre-control.firebaseapp.com",
    projectId: "hotellordpierre-control"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const HOTEL_ID = "lord-pierre";
  const roomsCol = collection(db, "hotels", HOTEL_ID, "rooms");
  const auditCol = collection(db, "hotels", HOTEL_ID, "audit");

  // === Operador (solo lectura aqu√≠; se establece en la UI de la Parte 2)
  function getStaffName() {
    const by = localStorage.getItem("staffName");
    if (!by || by.trim().length < 2) {
      throw new Error("OPERADOR_REQUERIDO");
    }
    return by.trim();
  }

  // Escritura centralizada con auditor√≠a
  window.syncRoom = async (roomId, data) => {
    const by = getStaffName(); // lanzar√° error si falta
    const payload = { ...data, updatedBy: by, updatedAt: serverTimestamp() };
    await setDoc(doc(roomsCol, String(roomId)), payload, { merge: true });
    await addDoc(auditCol, { roomId: String(roomId), by, at: serverTimestamp(), data });
  };

  // Atajo compatible con UI
  window.setRoomStatus = async (roomId, status) => {
    await window.syncRoom(roomId, { status });
  };

  // Realtime listener
  function tsToLocalString(ts) {
    try { return ts?.toDate ? ts.toDate().toLocaleString() : new Date().toLocaleString(); }
    catch { return new Date().toLocaleString(); }
  }

  onSnapshot(roomsCol, (snap) => {
    const rooms = [];
    snap.forEach((d) => rooms.push({ id: d.id, ...d.data() }));
    if (window.renderRooms) window.renderRooms(rooms); // se define en PARTE 2
    console.log("Realtime rooms:", rooms);
  });
</script>

<!-- === L√≥gica de interfaz === -->
<script>
/* ================== Datos base ================== */
const pisos={2:{inicio:200,fin:221},3:{inicio:300,fin:319},4:{inicio:400,fin:421}};
const COLOR_MAP={
  verde:{label:'Vac√≠o limpio',sigla:'VL'},
  naranja:{label:'Vac√≠o sucio',sigla:'VS'},
  amarillo:{label:'Ocupado',sigla:'OC'},
  rojo:{label:'Bloqueado',sigla:'BL'}
};
let pisoActivo=2,habitacionSeleccionada=null;
let modoResumen=false;
const menu=document.getElementById("menu");

/* ================== Operador ================== */
function hasOperator(){ 
  const n = localStorage.getItem("staffName");
  return !!(n && n.trim().length>=2);
}
function setOperator(name){
  const clean = (name||"").trim();
  if(clean.length<2){ alert("Escribe tu nombre (m√≠nimo 2 caracteres)."); return false; }
  localStorage.setItem("staffName", clean);
  pintarOperadorEnResumen();
  lockUI(false);
  return true;
}
function clearOperator(){
  localStorage.removeItem("staffName");
  pintarOperadorEnResumen();
  lockUI(true);
}
function lockUI(block){
  const isBlocked = !!block;

  // 1) No deshabilitar botones dentro de las cajas de operador
  document.querySelectorAll(".btn.primary, .btn.danger").forEach(b => {
    const box = b.closest(".box");
    if (box && box.id && box.id.startsWith("opbox")) return;
    b.disabled = isBlocked;
  });

  // 2) Ocultar men√∫ de colores si est√° bloqueado
  if (isBlocked) menu.style.display = "none";

  // 3) Bloqueo visual de paneles y mapa, excepto el cuadro de operador
  document.querySelectorAll(".mapa, .panel .box").forEach(el => {
    if (el.id && el.id.startsWith("opbox")) return;
    el.classList[isBlocked ? "add" : "remove"]("blocked");
  });
}
function pintarOperadorEnResumen(){
  const name = localStorage.getItem("staffName");
  document.querySelectorAll("[data-operator-chip]").forEach(el=>{
    el.textContent = name ? `Operador: ${name}` : "Operador: ‚Äî";
  });
}

/* ================== Utilidades ================== */
function safeReadAll(){
  try{ return JSON.parse(localStorage.getItem("datosHabitaciones")) || {2:{},3:{},4:{}}; }
  catch{ return {2:{},3:{},4:{}}; }
}
function safeWrite(piso,num,data){
  const all=safeReadAll(); if(!all[piso]) all[piso]={};
  all[piso][num]={...(all[piso][num]||{}),...data};
  localStorage.setItem("datosHabitaciones",JSON.stringify(all));
}
function obtenerColor(h){ return [...h.classList].find(c=>Object.keys(COLOR_MAP).includes(c))||"verde"; }
function setEtiqueta(h,color){ h.querySelector(".estado-label").textContent=COLOR_MAP[color].sigla; }
function syncStar(h,nota){
  const prev=h.querySelector(".estrella-nota"); if(prev) prev.remove();
  if(nota && nota.trim()){ const s=document.createElement("span"); s.className="estrella-nota"; s.textContent="‚òÖ"; h.appendChild(s); }
}
const ahoraStr = ()=> new Date().toLocaleString();

/* ================== Construcci√≥n de UI ================== */
function crearPiso(piso){
  const cont=document.getElementById(`piso${piso}`);
  cont.innerHTML=`
  <div class="titulo-piso">üìç Est√°s viendo: Piso ${piso}</div>
  <div class="contenedor">
    <!-- Panel izquierdo -->
    <div class="panel">
      <!-- === Caja de operador === -->
      <div class="box" id="opbox${piso}">
        <h3>üë§ Identif√≠cate</h3>
        <input type="text" id="opInput${piso}" placeholder="Nombre del operador (obligatorio)"/>
        <div class="actions">
          <button id="opGuardar${piso}" class="btn primary">Usar este nombre</button>
          <button id="opBorrar${piso}" class="btn">Cambiar</button>
          <span class="badge" data-operator-chip></span>
        </div>
        <div class="hint">Necesitas identificarte para guardar, eliminar o cambiar colores.</div>
      </div>

      <div class="box">
        <h3>üõèÔ∏è Configuraci√≥n de camas</h3>
        <table id="tablaCamas${piso}">
          <thead><tr><th>Cantidad</th><th>Tipo</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="actions">
          <button id="agregarCama${piso}" class="btn">+ Agregar cama</button>
        </div>
        <div class="actions">
          <button id="guardarCamas${piso}" class="btn primary" disabled>Guardar configuraci√≥n</button>
          <button id="eliminarCamas${piso}" class="btn danger" disabled>Eliminar todas</button>
          <span id="badgeCamas${piso}" class="badge"></span>
        </div>
      </div>
      <div class="box">
        <h3>üìä Resumen de habitaci√≥n</h3>
        <div class="hint" data-operator-chip></div>
        <div id="reloj${piso}" class="reloj"></div>
        <div id="resumenContenido${piso}" class="resumen"><p>Selecciona una habitaci√≥n...</p></div>
      </div>
    </div>

    <!-- Centro -->
    <div class="mapa" id="mapa${piso}"></div>

    <!-- Panel derecho -->
    <div class="panel">
      <div class="box">
        <h3>Significado de colores</h3>
        ${Object.entries(COLOR_MAP).map(([k,v])=>`
          <div class="leyenda-item"><div class="leyenda-color" style="background:var(--${k})"></div>${v.label} (${v.sigla})</div>`).join("")}
      </div>
      <div class="box">
        <h3 id="notaTitulo${piso}">üìã Nota de habitaci√≥n</h3>
        <textarea id="notaTexto${piso}" placeholder="Escribe aqu√≠ la nota..." disabled></textarea>
        <div class="actions">
          <button id="btnGuardar${piso}" class="btn primary" disabled>Guardar</button>
          <button id="btnEliminar${piso}" class="btn danger" disabled>Eliminar</button>
          <span id="badge${piso}" class="badge"></span>
        </div>
      </div>
      <div class="box"><div class="estado"><span class="swatch" id="swatch${piso}"></span><span id="estadoTexto${piso}">Sin selecci√≥n.</span></div></div>
    </div>
  </div>`;

  // listeners de operador (no dependen de PARTE 2)
  document.getElementById(`opGuardar${piso}`).onclick = () => {
    const val = document.getElementById(`opInput${piso}`).value;
    if(setOperator(val)){
      seleccionarHabitacion(habitacionSeleccionada || document.querySelector(`#piso${piso} .habitacion`), piso);
    }
  };
  document.getElementById(`opBorrar${piso}`).onclick = () => {
    clearOperator();
  };

  crearHabitaciones(piso);
}

function crearHabitaciones(piso){
  const mapa=document.getElementById(`mapa${piso}`); mapa.innerHTML="";
  const colP=document.createElement("div"), colI=document.createElement("div");
  colP.className="columna"; colI.className="columna";
  for(let n=pisos[piso].inicio;n<=pisos[piso].fin;n++){
    const h=document.createElement("div");
    h.className="habitacion verde"; h.dataset.num=n;
    h.innerHTML=`<div>${n}</div><span class="estado-label">VL</span>`;
    const saved=safeReadAll()?.[piso]?.[n];
    if(saved){
      if(saved.color){ h.className=`habitacion ${saved.color}`; setEtiqueta(h,saved.color); }
      if(saved.nota){ syncStar(h,saved.nota); }
    }
    // abrirMenu se define en PARTE 2
    h.onclick=e=>{ e.stopPropagation(); seleccionarHabitacion(h,piso); if(window.abrirMenu) abrirMenu(e); };
    (n%2===0?colP:colI).appendChild(h);
  }
  const wrap=document.createElement("div"); wrap.className="pasillo"; wrap.append(colP,colI); mapa.appendChild(wrap);
}

/* ================== Interacci√≥n (paneles) ================== */
function seleccionarHabitacion(h,piso){
  if(!h) return;
  document.querySelectorAll(`#piso${piso} .habitacion.selected`).forEach(x=>x.classList.remove("selected"));
  habitacionSeleccionada=h; pisoActivo=piso; h.classList.add("selected");
  actualizarPanelNota(); actualizarPanelEstado(); actualizarPanelCamas(); solicitarResumen();
}

function actualizarPanelNota(){
  const p=pisoActivo; if(!habitacionSeleccionada) return;
  const num=habitacionSeleccionada.dataset.num;
  const box=document.getElementById(`notaTexto${p}`);
  const titulo=document.getElementById(`notaTitulo${p}`);
  const btnG=document.getElementById(`btnGuardar${p}`);
  const btnE=document.getElementById(`btnEliminar${p}`);
  const badge=document.getElementById(`badge${p}`);
  const saved=safeReadAll()?.[p]?.[num]||{};

  box.disabled=false; btnG.disabled=false; btnE.disabled=false;
  box.value=saved.nota||"";
  titulo.textContent=`üìã Nota de habitaci√≥n ${num}${saved.nota?" ‚òÖ":""}`;

  const setBadge=m=>{ badge.textContent=m; setTimeout(()=>badge.textContent="",1200); };

  btnG.onclick=async ()=>{
    if(!hasOperator()){ alert("Identif√≠cate primero."); return; }
    const nota = box.value.trim();
    safeWrite(p,num,{nota,fecha:ahoraStr(),por:localStorage.getItem("staffName")});
    syncStar(habitacionSeleccionada,nota);
    setBadge("‚úÖ Guardado");
    solicitarResumen();
    try { await window.syncRoom(num, { note: nota }); } 
    catch(e){ if(String(e.message).includes("OPERADOR_REQUERIDO")) alert("Identif√≠cate en la tarjeta superior."); console.warn(e); }
  };
  btnE.onclick=async ()=>{
    if(!hasOperator()){ alert("Identif√≠cate primero."); return; }
    safeWrite(p, num, { nota: "", fecha: ahoraStr(), por: localStorage.getItem("staffName") });
    box.value=""; syncStar(habitacionSeleccionada,"");
    setBadge("üóëÔ∏è Eliminado");
    solicitarResumen();
    try { await window.syncRoom(num, { note: "" }); } 
    catch(e){ if(String(e.message).includes("OPERADOR_REQUERIDO")) alert("Identif√≠cate en la tarjeta superior."); console.warn(e); }
  };
}

function actualizarPanelEstado(){
  const p=pisoActivo; if(!habitacionSeleccionada) return;
  const num=habitacionSeleccionada.dataset.num;
  const color=obtenerColor(habitacionSeleccionada);
  const meta=COLOR_MAP[color];
  const et=document.getElementById(`estadoTexto${p}`);
  const sw=document.getElementById(`swatch${p}`);
  if(et) et.textContent=`Habitaci√≥n ${num} ‚Äî ${meta.label}.`;
  if(sw) sw.style.background=getComputedStyle(document.documentElement).getPropertyValue(`--${color}`);
}

function actualizarPanelCamas(){
  const p=pisoActivo;
  const tabla=document.querySelector(`#tablaCamas${p} tbody`);
  const btnG=document.getElementById(`guardarCamas${p}`);
  const btnE=document.getElementById(`eliminarCamas${p}`);
  const badge=document.getElementById(`badgeCamas${p}`);
  const btnAdd=document.getElementById(`agregarCama${p}`);

  if(!habitacionSeleccionada){
    if(tabla) tabla.innerHTML=""; [btnG,btnE,btnAdd].forEach(b=>b && (b.disabled=true)); return;
  }
  [btnG,btnE,btnAdd].forEach(b=>b && (b.disabled=false));

  const num=habitacionSeleccionada.dataset.num;
  const saved=safeReadAll()?.[p]?.[num]||{};
  const camas=saved.camas||[];
  if(tabla){
    tabla.innerHTML="";
    camas.forEach(c=>agregarFilaCama(p,c.cantidad,c.tipo));
  }

  const setBadge=m=>{ if(badge){ badge.textContent=m; setTimeout(()=>badge.textContent="",1200); } };

  if(btnAdd) btnAdd.onclick=()=>agregarFilaCama(p,"","");

  if(btnG) btnG.onclick=async ()=>{
    if(!hasOperator()){ alert("Identif√≠cate primero."); return; }
    const filas=[...tabla.querySelectorAll("tr")].map(tr=>({
      cantidad:tr.querySelector("input").value,
      tipo:tr.querySelector("select").value
    })).filter(x=>x.cantidad && x.tipo);
    safeWrite(p,num,{camas:filas,fecha:ahoraStr(),por:localStorage.getItem("staffName")});
    setBadge("‚úÖ Guardado");
    solicitarResumen();
    try { await window.syncRoom(num, { beds: filas }); }
    catch(e){ if(String(e.message).includes("OPERADOR_REQUERIDO")) alert("Identif√≠cate en la tarjeta superior."); console.warn(e); }
  };
  if(btnE) btnE.onclick=async ()=>{
    if(!hasOperator()){ alert("Identif√≠cate primero."); return; }
    safeWrite(p,num,{camas:[],fecha:ahoraStr(),por:localStorage.getItem("staffName")});
    if(tabla) tabla.innerHTML="";
    setBadge("üóëÔ∏è Eliminado");
    solicitarResumen();
    try { await window.syncRoom(num, { beds: [] }); }
    catch(e){ if(String(e.message).includes("OPERADOR_REQUERIDO")) alert("Identif√≠cate en la tarjeta superior."); console.warn(e); }
  };
}

function agregarFilaCama(p,cantidad="",tipo=""){
  const tabla=document.querySelector(`#tablaCamas${p} tbody`);
  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td><input type="number" min="1" value="${cantidad}" /></td>
    <td>
      <select>
        <option value="">Tipo...</option>
        <option ${tipo==="King"?"selected":""}>King</option>
        <option ${tipo==="Queen"?"selected":""}>Queen</option>
        <option ${tipo==="Doble"?"selected":""}>Doble</option>
        <option ${tipo==="Individual"?"selected":""}>Individual</option>
        <option ${tipo==="Mixta"?"selected":""}>Mixta</option>
      </select>
    </td>
    <td><button class="delete-btn" title="Eliminar fila">√ó</button></td>
  `;
  tr.querySelector(".delete-btn").onclick=()=>tr.remove();
  if(tabla) tabla.appendChild(tr);
}

/* ================== Resumen (KPIs + mini-mapas) ================== */
function contarPorColor(piso){
  const all = safeReadAll()?.[piso] || {};
  const counts = {verde:0,naranja:0,amarillo:0,rojo:0};
  for(let n=pisos[piso].inicio;n<=pisos[piso].fin;n++){
    const c = (all[n]?.color) || "verde";
    counts[c] = (counts[c]||0)+1;
  }
  return counts;
}
function pintarKpis(piso){
  const c = contarPorColor(piso);
  const k = document.getElementById(`kpis${piso}`);
  if(!k) return;
  k.innerHTML = `
    ${['verde','naranja','amarillo','rojo'].map(kc =>
      `<span class="chip"><span class="dot" style="background:var(--${kc})"></span>${COLOR_MAP[kc].sigla}: <b>${c[kc]}</b></span>`
    ).join('')}
    <span class="chip">Total: <b>${Object.values(c).reduce((a,b)=>a+b,0)}</b></span>`;
}
function crearMiniHabitaciones(piso){
  const mapa = document.getElementById(`miniMapa${piso}`); if(!mapa) return;
  mapa.innerHTML = "";
  const colP = document.createElement("div"), colI = document.createElement("div");
  colP.className="columna"; colI.className="columna";

  for(let n=pisos[piso].inicio;n<=pisos[piso].fin;n++){
    const h=document.createElement("div");
    h.className="habitacion verde"; h.dataset.num=n;
    h.innerHTML=`<div>${n}</div><span class="estado-label">VL</span>`;
    const saved=safeReadAll()?.[piso]?.[n];
    if(saved){
      if(saved.color){ h.className=`habitacion ${saved.color}`; setEtiqueta(h,saved.color); }
      if(saved.nota){ syncStar(h,saved.nota); }
    }
    h.onclick=(e)=>{ e.stopPropagation(); seleccionarMini(h,piso); if(window.abrirMenu) abrirMenu(e); };
    (n%2===0?colP:colI).appendChild(h);
  }
  const wrap=document.createElement("div"); wrap.className="pasillo"; wrap.append(colP,colI); mapa.appendChild(wrap);
}
function seleccionarMini(h,piso){
  document.querySelectorAll(`#miniMapa${piso} .habitacion.selected`).forEach(x=>x.classList.remove("selected"));
  habitacionSeleccionada=h; pisoActivo=piso; h.classList.add("selected");
  actualizarMiniResumen(piso);
}
function actualizarMiniResumen(piso){
  const num = habitacionSeleccionada?.dataset?.num;
  const resumen = document.getElementById(`miniResumen${piso}`);
  const estadoT = document.getElementById(`miniEstado${piso}`);
  const swatch  = document.getElementById(`miniSwatch${piso}`);

  if(!num){
    if(resumen) resumen.innerHTML = "<p>Selecciona una habitaci√≥n‚Ä¶</p>";
    if(estadoT) estadoT.textContent = "Selecciona una habitaci√≥n‚Ä¶";
    return;
  }
  const saved = safeReadAll()?.[piso]?.[num] || {};
  const color = obtenerColor(habitacionSeleccionada);
  const meta  = COLOR_MAP[color];
  if(estadoT) estadoT.textContent = `Habitaci√≥n ${num} ‚Äî ${meta.label}.`;
  if(swatch)  swatch.style.background = getComputedStyle(document.documentElement).getPropertyValue(`--${color}`);

  const camasTxt = (saved.camas && saved.camas.length) ? saved.camas.map(c=>`${c.cantidad} ${c.tipo}`).join(", ") : "Sin registrar";
  const notaTxt  = saved.nota || "‚Äî";
  const fechaTxt = saved.fecha || "Sin registrar";
  const porTxt   = saved.por || "‚Äî";
  if(resumen){
    resumen.innerHTML = `
      <p><strong>Camas:</strong> ${camasTxt}</p>
      <p><strong>Nota:</strong> ${notaTxt}</p>
      <p><strong>√ölt. mod.:</strong> ${fechaTxt} <em>por</em> ${porTxt}</p>`;
  }
}
function renderResumenGlobal(){
  const wrap = document.getElementById("resumenView");
  if(!wrap) return;
  wrap.innerHTML = "";
  [2,3,4].forEach(p=>{
    const card = document.createElement("div");
    card.className = "resumen-card mini";
    card.innerHTML = `
      <h3>piso n√∫mero ${p}</h3>
      <div class="kpis" id="kpis${p}"></div>
      <div class="mini-mapa" id="miniMapa${p}"></div>
      <div class="box">
        <div class="estado">
          <span class="swatch" id="miniSwatch${p}"></span>
          <span id="miniEstado${p}">Selecciona una habitaci√≥n‚Ä¶</span>
        </div>
        <div id="miniResumen${p}" class="resumen"><p>‚Äî</p></div>
      </div>`;
    wrap.appendChild(card);
    crearMiniHabitaciones(p);
    pintarKpis(p);
  });
}

/* ================== Resumen (throttle) ================== */
let needsResumen=true;
function solicitarResumen(){ needsResumen=true; }
function actualizarResumen(){
  const p=pisoActivo;
  const resumen=document.getElementById(`resumenContenido${p}`);
  const reloj=document.getElementById(`reloj${p}`);
  if(reloj) reloj.textContent=new Date().toLocaleTimeString();

  if(!habitacionSeleccionada){
    if(resumen) resumen.innerHTML="<p>Selecciona una habitaci√≥n...</p>";
    return;
  }
  const num=habitacionSeleccionada.dataset.num;
  const saved=safeReadAll()?.[p]?.[num]||{};
  const color=obtenerColor(habitacionSeleccionada);
  const meta=COLOR_MAP[color];

  const camasTxt=(saved.camas&&saved.camas.length)
    ? saved.camas.map(c=>`${c.cantidad} ${c.tipo}`).join(", ")
    : "Sin registrar";
  const notaTxt=saved.nota?saved.nota:"‚Äî";
  const fechaTxt=saved.fecha?saved.fecha:"Sin registrar";
  const operadorActivo = localStorage.getItem("staffName") || "‚Äî";
  const modifico = saved.por || "‚Äî"; 

  if(resumen) resumen.innerHTML=`
    <p><strong>Operador activo:</strong> ${operadorActivo}</p>
    <p><strong>Habitaci√≥n:</strong> ${num}</p>
    <p><strong>Estado:</strong> ${meta.label}</p>
    <p><strong>Camas:</strong> ${camasTxt}</p>
    <p><strong>√öltima nota:</strong> ${notaTxt}</p>
    <p><strong>√öltima modificaci√≥n:</strong> ${fechaTxt}</p>
    <p><strong>√öltima modificaci√≥n por:</strong> ${modifico}</p>`;
}
setInterval(()=>{
  if(needsResumen){ actualizarResumen(); needsResumen=false; }
  const p=pisoActivo; const reloj=document.getElementById(`reloj${p}`);
  if(reloj) reloj.textContent=new Date().toLocaleTimeString();
},1000);

/* ================== Inicializaci√≥n m√≠nima (sin listeners de pisos/men√∫) ================== */
[2,3,4].forEach(crearPiso);
pintarOperadorEnResumen();
lockUI(!hasOperator());

// Los listeners de botones de piso, el men√∫ de colores y el renderRooms
// en tiempo real se agregan en la PARTE 2/2.
</script>
<!-- === L√≥gica final ‚Äî PARTE 2/2 (listeners, men√∫ de colores y realtime) === -->
<script>
/* ================== Navegaci√≥n de pisos (incluye modo Resumen) ================== */
document.querySelectorAll(".btn-piso").forEach(btn=>{
  btn.addEventListener("click",()=>{
    if(btn.classList.contains("active")) return;

    document.querySelectorAll(".btn-piso").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const key = btn.dataset.piso;

    // Cierra men√∫ de colores si estuviera abierto
    menu.style.display="none";

    if(key === "resumen"){
      modoResumen = true;
      // Oculta pisos y muestra tablero
      document.querySelectorAll(".piso").forEach(p=>p.classList.remove("active"));
      document.getElementById("resumenView").classList.add("active");
      habitacionSeleccionada = null;
      renderResumenGlobal();
      lockUI(!hasOperator());
    } else {
      modoResumen = false;
      document.getElementById("resumenView").classList.remove("active");

      const piso = Number(key);
      document.querySelectorAll(".piso").forEach(p=>p.classList.remove("active"));
      document.getElementById(`piso${piso}`).classList.add("active");

      pisoActivo = piso;
      habitacionSeleccionada = null;
      actualizarPanelNota(); 
      actualizarPanelEstado(); 
      actualizarPanelCamas(); 
      solicitarResumen();
    }
  });
});

/* ================== Men√∫ de colores ================== */
function abrirMenu(e){
  if(!hasOperator()){ alert("Identif√≠cate primero."); return; }
  menu.style.left=`${e.clientX+10}px`;
  menu.style.top =`${e.clientY+10}px`;
  menu.style.display="block";
}
window.abrirMenu = abrirMenu;

window.addEventListener("click",e=>{
  if(!menu.contains(e.target) && !e.target.classList.contains("habitacion")){
    menu.style.display="none";
  }
});

menu.querySelectorAll(".color-opcion").forEach(opt=>{
  opt.addEventListener("click", async ()=>{
    if(!habitacionSeleccionada) return;
    if(!hasOperator()){ alert("Identif√≠cate primero."); return; }

    const color = opt.dataset.color;
    const p     = pisoActivo;
    const num   = habitacionSeleccionada.dataset.num;

    // Aplica color en UI
    habitacionSeleccionada.className=`habitacion ${color}`;
    setEtiqueta(habitacionSeleccionada,color);

    // Mant√©n resto de datos y persiste en cache local
    const prev = safeReadAll()?.[p]?.[num] || {};
    safeWrite(p, num, {
      color,
      nota:  prev.nota || "",
      camas: prev.camas || [],
      fecha: ahoraStr(),
      por:   localStorage.getItem("staffName")
    });

    actualizarPanelEstado(); 
    solicitarResumen();
    menu.style.display="none";

    // Actualiza KPIs/mini si est√°s en modo resumen
    if(modoResumen){
      pintarKpis(p);
      actualizarMiniResumen(p);
    }

    // Sincroniza en Firestore
    try { await window.syncRoom(num, { status: color }); }
    catch(e){ if(String(e.message).includes("OPERADOR_REQUERIDO")) alert("Identif√≠cate en la tarjeta superior."); console.warn(e); }
  });
});

/* ================== Realtime Firestore ‚Üí DOM (vista normal + mini) ================== */
window.renderRooms = (rooms) => {
  rooms.forEach(r => {
    const idStr = String(r.id);
    const status = r.status || "verde";
    const nota   = r.note   || "";
    const camas  = r.beds   || [];
    const fecha  = (r.updatedAt && r.updatedAt.toDate) ? r.updatedAt.toDate().toLocaleString() : ahoraStr();
    const por    = r.updatedBy || r.by || "";

    // Deducci√≥n de piso por el primer d√≠gito (201 ‚Üí 2, 305 ‚Üí 3, etc.)
    const piso = Number(idStr[0]);
    if(![2,3,4].includes(piso)) return;

    // Cache local
    safeWrite(piso, idStr, { color: status, nota, camas, fecha, por });

    // Actualiza room en la vista "grande" (si existe en DOM)
    const bigEl = document.querySelector(`.habitacion[data-num="${idStr}"]`);
    if(bigEl){
      bigEl.className = `habitacion ${status}`;
      setEtiqueta(bigEl, status);
      syncStar(bigEl, nota);
    }

    // Actualiza room en mini-mapa (si existe)
    const miniEl = document.querySelector(`#miniMapa${piso} .habitacion[data-num="${idStr}"]`);
    if(miniEl){
      miniEl.className = `habitacion ${status}`;
      setEtiqueta(miniEl, status);
      syncStar(miniEl, nota);
    }

    // Refresca KPIs y paneles
    if(modoResumen){
      pintarKpis(piso);
      // Si la habitaci√≥n afectada est√° seleccionada en la mini, actualiza recuadro
      const isSelectedMini = miniEl && miniEl.classList.contains("selected");
      if(isSelectedMini) actualizarMiniResumen(piso);
    } else {
      if(habitacionSeleccionada && habitacionSeleccionada.dataset.num === idStr){
        actualizarPanelNota(); actualizarPanelEstado(); solicitarResumen();
      }
    }
  });
};
</script>
</body>
</html>
